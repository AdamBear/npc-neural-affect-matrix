# NPC Neural Affect Matrix - ç®—æ³•åˆ†ææ–‡æ¡£

## ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [æƒ…ç»ªè®¡ç®—æµç¨‹](#æƒ…ç»ªè®¡ç®—æµç¨‹)
4. [ç®—æ³•è¯¦è§£](#ç®—æ³•è¯¦è§£)
5. [æ•°å­¦æ¨¡å‹](#æ•°å­¦æ¨¡å‹)
6. [å‚æ•°å½±å“åˆ†æ](#å‚æ•°å½±å“åˆ†æ)
7. [å®é™…æ¡ˆä¾‹](#å®é™…æ¡ˆä¾‹)

---

## ç³»ç»Ÿæ¦‚è¿°

NPC Neural Affect Matrix æ˜¯ä¸€ä¸ªåŸºäº**æƒ…æ„ŸäºŒç»´æ¨¡å‹**ï¼ˆValence-Arousal Modelï¼‰çš„ NPC æƒ…ç»ªç³»ç»Ÿï¼Œç»“åˆäº†ï¼š
- **ç¥ç»ç½‘ç»œæƒ…æ„Ÿé¢„æµ‹**ï¼šä½¿ç”¨ BERT æ¨¡å‹é¢„æµ‹æ–‡æœ¬æƒ…ç»ª
- **è®°å¿†è¡°å‡æœºåˆ¶**ï¼šåŸºäºæŒ‡æ•°è¡°å‡çš„è®°å¿†æƒé‡
- **å¿ƒç†å­¦èåˆç®—æ³•**ï¼šå¤šå±‚æ¬¡æƒ…ç»ªçŠ¶æ€èåˆ

### æƒ…æ„ŸäºŒç»´æ¨¡å‹

```
          é«˜å”¤é†’ (Arousal = 1.0)
                  |
        æ„¤æ€’ ğŸ˜    |   å…´å¥‹ ğŸ˜ƒ
                  |
è´Ÿæ„‰æ‚¦ -----------|----------- æ­£æ„‰æ‚¦
(Valence=-1.0)    |    (Valence=1.0)
                  |
        æ‚²ä¼¤ ğŸ˜¢   |   å¹³é™ ğŸ˜Œ
                  |
          ä½å”¤é†’ (Arousal = -1.0)
```

**ä¸¤ä¸ªæ ¸å¿ƒç»´åº¦**:
- **Valence (æ„‰æ‚¦åº¦)**: -1.0ï¼ˆæåº¦è´Ÿé¢ï¼‰åˆ° 1.0ï¼ˆæåº¦æ­£é¢ï¼‰
- **Arousal (å”¤é†’åº¦)**: -1.0ï¼ˆæåº¦å¹³é™ï¼‰åˆ° 1.0ï¼ˆæåº¦æ¿€åŠ¨ï¼‰

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. NPC é…ç½®å‚æ•°

```rust
pub struct NpcConfig {
    pub identity: Identity,           // NPC èº«ä»½ä¿¡æ¯
    pub personality: PersonalityTraits, // åŸºç¡€æ€§æ ¼
    pub memory: MemoryConfig,          // è®°å¿†é…ç½®
}

pub struct PersonalityTraits {
    pub valence: f32,   // åŸºç¡€æ„‰æ‚¦åº¦ [-1.0, 1.0]
    pub arousal: f32,   // åŸºç¡€å”¤é†’åº¦ [-1.0, 1.0]
}

pub struct MemoryConfig {
    pub decay_rate: f32,  // è®°å¿†è¡°å‡ç‡ï¼ˆé»˜è®¤ 0.1ï¼‰
}
```

**å‚æ•°è¯´æ˜**:
- `personality.valence`: NPC çš„åŸºç¡€æ€§æ ¼æ„‰æ‚¦åº¦
  - `-1.0`: æ‚²è§‚ã€æ¶ˆæçš„æ€§æ ¼
  - `0.0`: ä¸­æ€§æ€§æ ¼
  - `1.0`: ä¹è§‚ã€ç§¯æçš„æ€§æ ¼

- `personality.arousal`: NPC çš„åŸºç¡€æƒ…ç»ªæ´»è·ƒåº¦
  - `-1.0`: éå¸¸å¹³é™ã€å†·æ¼ 
  - `0.0`: ä¸­ç­‰æ´»è·ƒ
  - `1.0`: éå¸¸æ¿€åŠ¨ã€æ´»è·ƒ

- `memory.decay_rate`: è®°å¿†è¡°å‡é€Ÿç‡
  - å€¼è¶Šå¤§ï¼Œæ—§è®°å¿†å½±å“è¶Šå¿«è¡°å‡
  - å€¼è¶Šå°ï¼Œæ—§è®°å¿†å½±å“ä¿æŒè¶Šä¹…

### 2. è®°å¿†è®°å½•

```rust
pub struct MemoryRecord {
    pub id: String,         // è®°å½•å”¯ä¸€ ID
    pub source_id: String,  // äº¤äº’æ¥æºï¼ˆå¦‚ "player", "enemy"ï¼‰
    pub text: String,       // äº¤äº’æ–‡æœ¬
    pub valence: f32,       // è¯¥è®°å¿†çš„æ„‰æ‚¦åº¦
    pub arousal: f32,       // è¯¥è®°å¿†çš„å”¤é†’åº¦
    pub past_time: i64,     // è·ç°åœ¨çš„æ—¶é—´ï¼ˆç”¨äºè¡°å‡è®¡ç®—ï¼‰
}
```

---

## æƒ…ç»ªè®¡ç®—æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     1. äº¤äº’è¾“å…¥                                    â”‚
â”‚                     æ–‡æœ¬: "Hello friend!"                          â”‚
â”‚                     æ¥æº: "player"                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              2. ç¥ç»ç½‘ç»œæƒ…æ„Ÿé¢„æµ‹ (BERT)                            â”‚
â”‚              predict_emotion_from_text(text)                       â”‚
â”‚              â†“                                                     â”‚
â”‚              text_emotion = {valence: 0.514, arousal: 0.116}      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              3. è®¡ç®—è®°å¿†æƒ…ç»ªçŠ¶æ€                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚              â”‚  å…¨å±€æƒ…ç»ª        â”‚  é’ˆå¯¹æ¥æºæƒ…ç»ª    â”‚               â”‚
â”‚              â”‚  (æ‰€æœ‰è®°å¿†)      â”‚  (ç‰¹å®šæ¥æºè®°å¿†)  â”‚               â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                       â”‚                  â”‚                        â”‚
â”‚                       â–¼                  â–¼                        â”‚
â”‚       global_emotion = {v: 0.2, a: 0.1}                          â”‚
â”‚       source_emotion = {v: 0.3, a: 0.15}  (if æ¥æºå­˜åœ¨)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              4. å¿ƒç†å­¦èåˆ (Psychological Combination)             â”‚
â”‚                                                                    â”‚
â”‚              å¦‚æœæœ‰é’ˆå¯¹æ¥æºçš„æƒ…ç»ª:                                  â”‚
â”‚              final = 0.5Ã—source + 0.35Ã—text + 0.15Ã—global        â”‚
â”‚                                                                    â”‚
â”‚              å¦‚æœæ²¡æœ‰é’ˆå¯¹æ¥æºçš„æƒ…ç»ª:                                â”‚
â”‚              final = 0.7Ã—text + 0.3Ã—global                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              5. å­˜å‚¨åˆ°è®°å¿†                                          â”‚
â”‚              æ–°è®°å½• = {text, final_valence, final_arousal, ...}   â”‚
â”‚              è‡ªåŠ¨ä¿å­˜åˆ° JSON æ–‡ä»¶                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç®—æ³•è¯¦è§£

### ç®—æ³• 1: ç¥ç»ç½‘ç»œæƒ…æ„Ÿé¢„æµ‹

**æ–‡ä»¶ä½ç½®**: `src/modules/emotion/predictor.rs:209-259`

```rust
pub fn predict_emotion_from_text(&mut self, text: &str)
    -> Result<EmotionPrediction, EmotionPredictorError>
```

**æ­¥éª¤**:
1. **åˆ†è¯ (Tokenization)**
   ```rust
   let encoding = self.tokenizer.encode(text, true)?;
   let token_ids = encoding.get_ids().to_vec();
   ```

2. **å¡«å……/æˆªæ–­åˆ°å›ºå®šé•¿åº¦ (Padding/Truncation)**
   ```rust
   max_length = 512
   if len(token_ids) > 512: æˆªæ–­
   if len(token_ids) < 512: ç”¨ 0 å¡«å……
   ```

3. **ONNX æ¨¡å‹æ¨ç†**
   ```rust
   outputs = session.run(inputs![
       "input_ids" => input_ids,
       "attention_mask" => attention_mask
   ])
   ```

4. **è¾“å‡ºè§£æ**
   ```rust
   valence = predictions[[0, 0]]  // ç¬¬ä¸€ä¸ªè¾“å‡º
   arousal = predictions[[0, 1]]  // ç¬¬äºŒä¸ªè¾“å‡º
   ```

**ç¥ç»ç½‘ç»œæ¶æ„**:
- **æ¨¡å‹**: åŸºäº BERT çš„æƒ…æ„Ÿåˆ†ç±»å™¨
- **æ¥æº**: Hugging Face - `Mavdol/NPC-Valence-Arousal-Prediction-ONNX`
- **è¾“å…¥**: æ–‡æœ¬åºåˆ—ï¼ˆæœ€å¤š512ä¸ªtokenï¼‰
- **è¾“å‡º**: [valence, arousal] ä¸¤ä¸ªå®æ•°å€¼

---

### ç®—æ³• 2: è®°å¿†åŠ æƒæƒ…ç»ªè®¡ç®—

**æ–‡ä»¶ä½ç½®**: `src/modules/memory/evaluator.rs:87-121`

```rust
fn calculate_weighted_emotion(&self, records: &[MemoryRecord])
    -> (f32, f32)
```

è¿™æ˜¯**æ ¸å¿ƒç®—æ³•**ï¼Œå†³å®šäº†å†å²è®°å¿†å¦‚ä½•å½±å“å½“å‰æƒ…ç»ªã€‚

#### æ•°å­¦å…¬å¼

å¯¹äºæ¯æ¡è®°å¿†è®°å½• $i$ï¼š

**1. æ—¶é—´è¡°å‡æƒé‡**
```
weight_i = e^(-decay_rate Ã— past_time_i)
```

å…¶ä¸­:
- $e$ = 2.71828... (è‡ªç„¶å¯¹æ•°åº•)
- `decay_rate` = è®°å¿†è¡°å‡ç‡ï¼ˆé»˜è®¤ 0.1ï¼‰
- `past_time_i` = è¯¥è®°å¿†è·ç°åœ¨çš„æ—¶é—´

**2. æƒ…ç»ªåå·®è®¡ç®—**
```
valence_deviation_i = record.valence - personality.valence
arousal_deviation_i = record.arousal - personality.arousal
```

**3. åŠ æƒç´¯ç§¯**
```
weighted_valence = Î£ (valence_deviation_i Ã— weight_i)
weighted_arousal = Î£ (arousal_deviation_i Ã— weight_i)
total_weight = Î£ weight_i
```

**4. æœ€ç»ˆæƒ…ç»ªè®¡ç®—**
```
final_valence = clamp((weighted_valence / total_weight) + personality.valence, -1.0, 1.0)
final_arousal = clamp((weighted_arousal / total_weight) + personality.arousal, -1.0, 1.0)
```

#### ä»£ç å®ç°

```rust
fn calculate_weighted_emotion(&self, records: &[MemoryRecord]) -> (f32, f32) {
    let decay_rate = self.config.memory.decay_rate;
    let personality_valence = self.config.personality.valence;
    let personality_arousal = self.config.personality.arousal;

    let mut weighted_valence = 0.0;
    let mut weighted_arousal = 0.0;
    let mut total_weight = 0.0;

    for record in records {
        // æŒ‡æ•°è¡°å‡æƒé‡
        let weight = E.powf(-decay_rate * record.past_time as f32);

        // ç›¸å¯¹äºåŸºç¡€æ€§æ ¼çš„åå·®
        let valence_deviation = record.valence - personality_valence;
        let arousal_deviation = record.arousal - personality_arousal;

        // åŠ æƒç´¯ç§¯
        weighted_valence += valence_deviation * weight;
        weighted_arousal += arousal_deviation * weight;
        total_weight += weight;
    }

    // è®¡ç®—æœ€ç»ˆæƒ…ç»ªï¼ˆåŠ å›åŸºç¡€æ€§æ ¼ï¼‰
    let final_valence = if total_weight > 0.0 {
        ((weighted_valence / total_weight) + personality_valence)
            .clamp(-1.0, 1.0)
    } else {
        personality_valence
    };

    let final_arousal = if total_weight > 0.0 {
        ((weighted_arousal / total_weight) + personality_arousal)
            .clamp(-1.0, 1.0)
    } else {
        personality_arousal
    };

    (final_valence, final_arousal)
}
```

---

### ç®—æ³• 3: å¿ƒç†å­¦æƒ…ç»ªèåˆ

**æ–‡ä»¶ä½ç½®**: `src/modules/memory/evaluator.rs:123-145`

```rust
fn combine_emotions_psychologically(
    &self,
    text_emotion: &EmotionPrediction,      // æ–‡æœ¬é¢„æµ‹çš„æƒ…ç»ª
    source_emotion: Option<&EmotionPrediction>, // é’ˆå¯¹æ¥æºçš„è®°å¿†æƒ…ç»ª
    global_emotion: &EmotionPrediction,     // å…¨å±€è®°å¿†æƒ…ç»ª
) -> EmotionPrediction
```

#### èåˆç­–ç•¥

**æƒ…å†µ 1: æœ‰é’ˆå¯¹ç‰¹å®šæ¥æºçš„å†å²**
```
final_valence = 0.5 Ã— source_valence + 0.35 Ã— text_valence + 0.15 Ã— global_valence
final_arousal = 0.5 Ã— source_arousal + 0.35 Ã— text_arousal + 0.15 Ã— global_arousal
```

**æƒé‡è§£é‡Š**:
- **50%** æ¥è‡ªå¯¹è¯¥æ¥æºçš„å†å²æƒ…ç»ªï¼ˆæœ€é‡è¦ï¼‰
- **35%** æ¥è‡ªå½“å‰æ–‡æœ¬çš„æƒ…ç»ª
- **15%** æ¥è‡ªæ•´ä½“è®°å¿†çš„æƒ…ç»ª

**æƒ…å†µ 2: æ²¡æœ‰é’ˆå¯¹ç‰¹å®šæ¥æºçš„å†å²**
```
final_valence = 0.7 Ã— text_valence + 0.3 Ã— global_valence
final_arousal = 0.7 Ã— text_arousal + 0.3 Ã— global_arousal
```

**æƒé‡è§£é‡Š**:
- **70%** æ¥è‡ªå½“å‰æ–‡æœ¬çš„æƒ…ç»ªï¼ˆä¸»å¯¼ï¼‰
- **30%** æ¥è‡ªæ•´ä½“è®°å¿†çš„æƒ…ç»ª

#### å¿ƒç†å­¦ä¾æ®

è¿™ä¸ªèåˆç­–ç•¥æ¨¡æ‹Ÿäº†äººç±»æƒ…ç»ªå“åº”çš„å¿ƒç†å­¦ç‰¹å¾ï¼š

1. **å…³ç³»è®°å¿†ä¼˜å…ˆ**: ä¸ç‰¹å®šå¯¹è±¡çš„å†å²å…³ç³»æœ€å½±å“å½“å‰æƒ…ç»ª
2. **æƒ…å¢ƒæ•æ„Ÿæ€§**: å½“å‰äº¤äº’å†…å®¹æœ‰æ˜¾è‘—å½±å“
3. **æ•´ä½“åŸºè°ƒ**: æ•´ä½“å¿ƒç†çŠ¶æ€æä¾›èƒŒæ™¯è‰²è°ƒ

---

## æ•°å­¦æ¨¡å‹

### å®Œæ•´æƒ…ç»ªè®¡ç®—å…¬å¼

è®¾ï¼š
- $P_v$, $P_a$ = åŸºç¡€æ€§æ ¼çš„ valence å’Œ arousal
- $T_v$, $T_a$ = æ–‡æœ¬é¢„æµ‹çš„ valence å’Œ arousal
- $M = \{m_1, m_2, ..., m_n\}$ = æ‰€æœ‰è®°å¿†
- $M_s \subseteq M$ = é’ˆå¯¹æ¥æº $s$ çš„è®°å¿†
- $\lambda$ = decay_rateï¼ˆè¡°å‡ç‡ï¼‰
- $t_i$ = è®°å¿† $i$ çš„ past_time

#### æ­¥éª¤ 1: è®¡ç®—è®°å¿†æƒ…ç»ª

**å…¨å±€è®°å¿†æƒ…ç»ª** $G_v, G_a$:
$$
w_i = e^{-\lambda t_i}
$$
$$
G_v = P_v + \frac{\sum_{i=1}^{n} w_i \cdot (m_{i,v} - P_v)}{\sum_{i=1}^{n} w_i}
$$
$$
G_a = P_a + \frac{\sum_{i=1}^{n} w_i \cdot (m_{i,a} - P_a)}{\sum_{i=1}^{n} w_i}
$$

**é’ˆå¯¹æ¥æºçš„è®°å¿†æƒ…ç»ª** $S_v, S_a$ (å¦‚æœå­˜åœ¨):
$$
S_v = P_v + \frac{\sum_{j \in M_s} w_j \cdot (m_{j,v} - P_v)}{\sum_{j \in M_s} w_j}
$$
$$
S_a = P_a + \frac{\sum_{j \in M_s} w_j \cdot (m_{j,a} - P_a)}{\sum_{j \in M_s} w_j}
$$

#### æ­¥éª¤ 2: æƒ…ç»ªèåˆ

**æœ‰æ¥æºå†å²æ—¶**:
$$
F_v = \text{clamp}(0.5 S_v + 0.35 T_v + 0.15 G_v, -1, 1)
$$
$$
F_a = \text{clamp}(0.5 S_a + 0.35 T_a + 0.15 G_a, -1, 1)
$$

**æ— æ¥æºå†å²æ—¶**:
$$
F_v = \text{clamp}(0.7 T_v + 0.3 G_v, -1, 1)
$$
$$
F_a = \text{clamp}(0.7 T_a + 0.3 G_a, -1, 1)
$$

å…¶ä¸­ $\text{clamp}(x, a, b) = \max(a, \min(x, b))$

---

## å‚æ•°å½±å“åˆ†æ

### 1. `personality.valence` çš„å½±å“

| å€¼ | å«ä¹‰ | è¡Œä¸ºç‰¹å¾ |
|----|------|---------|
| -1.0 | æåº¦æ‚²è§‚ | å³ä½¿ç§¯æäº‹ä»¶ä¹Ÿéš¾ä»¥æ”¹å˜è´Ÿé¢æƒ…ç»ª |
| -0.5 | æ‚²è§‚å€¾å‘ | æ›´å®¹æ˜“å—è´Ÿé¢è®°å¿†å½±å“ |
| 0.0 | ä¸­æ€§ | å¯¹æ­£è´Ÿé¢äº‹ä»¶ååº”å¹³è¡¡ |
| 0.5 | ä¹è§‚å€¾å‘ | æ›´å®¹æ˜“ä»è´Ÿé¢äº‹ä»¶ä¸­æ¢å¤ |
| 1.0 | æåº¦ä¹è§‚ | å³ä½¿è´Ÿé¢äº‹ä»¶ä¹Ÿä¿æŒè¾ƒç§¯æçš„æƒ…ç»ª |

**ç¤ºä¾‹**:
```rust
// ä¹è§‚çš„å•†äºº
personality: { valence: 0.3, arousal: 0.0 }

// æ‚²è§‚çš„å“¨å…µ
personality: { valence: -0.2, arousal: 0.1 }
```

### 2. `personality.arousal` çš„å½±å“

| å€¼ | å«ä¹‰ | è¡Œä¸ºç‰¹å¾ |
|----|------|---------|
| -1.0 | æåº¦å¹³é™ | å‡ ä¹ä¸å—åˆºæ¿€å½±å“ï¼Œååº”è¿Ÿç¼“ |
| -0.5 | å†·é™ | æƒ…ç»ªç¨³å®šï¼Œä¸æ˜“æ¿€åŠ¨ |
| 0.0 | ä¸­æ€§ | æ­£å¸¸ååº”æ°´å¹³ |
| 0.5 | æ´»è·ƒ | å®¹æ˜“å…´å¥‹æˆ–æ¿€åŠ¨ |
| 1.0 | æåº¦æ´»è·ƒ | å¯¹ä»»ä½•åˆºæ¿€éƒ½å¼ºçƒˆååº” |

**ç¤ºä¾‹**:
```rust
// å†·é™çš„å­¦è€…
personality: { valence: 0.0, arousal: -0.3 }

// æ¿€åŠ¨çš„å°å­©
personality: { valence: 0.2, arousal: 0.6 }
```

### 3. `memory.decay_rate` çš„å½±å“

è®°å¿†æƒé‡éšæ—¶é—´çš„è¡°å‡æ›²çº¿ï¼š

```
weight = e^(-decay_rate Ã— time)

decay_rate = 0.01 (è®°æ€§å¾ˆå¥½)
time=0:   weight=1.000
time=10:  weight=0.905
time=50:  weight=0.607
time=100: weight=0.368

decay_rate = 0.1 (é»˜è®¤)
time=0:   weight=1.000
time=10:  weight=0.368
time=50:  weight=0.007
time=100: weight=0.000

decay_rate = 0.5 (è®°æ€§å·®)
time=0:   weight=1.000
time=10:  weight=0.007
time=50:  weight=0.000
```

**å½±å“**:
- **ä½å€¼ (0.01-0.05)**: é•¿æœŸè®°å¿†ï¼ŒNPC ä¼šè®°ä½å¾ˆä¹…ä¹‹å‰çš„äº‹
- **ä¸­å€¼ (0.1-0.2)**: å¹³è¡¡è®°å¿†ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯
- **é«˜å€¼ (0.5-1.0)**: çŸ­æœŸè®°å¿†ï¼Œåªå—æœ€è¿‘äº‹ä»¶å½±å“

---

## å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: å‹å–„çš„å•†äººé‡åˆ°å‹å¥½ç©å®¶

**åˆå§‹é…ç½®**:
```json
{
  "identity": {
    "name": "Marcus the Shopkeeper",
    "background": "A friendly merchant"
  },
  "personality": {
    "valence": 0.3,    // ä¹è§‚å‹å–„
    "arousal": -0.1    // è¾ƒä¸ºå¹³é™
  },
  "memory": {
    "decay_rate": 0.1
  }
}
```

**äº¤äº’åºåˆ—**:

#### äº¤äº’ 1: "Thank you for all your help!"
1. **ç¥ç»ç½‘ç»œé¢„æµ‹**: `{valence: 0.457, arousal: 0.071}`
2. **å…¨å±€è®°å¿†æƒ…ç»ª**: æ— è®°å¿†ï¼Œè¿”å›åŸºç¡€æ€§æ ¼ `{valence: 0.3, arousal: -0.1}`
3. **èåˆ**ï¼ˆæ— æ¥æºå†å²ï¼‰:
   ```
   valence = 0.7 Ã— 0.457 + 0.3 Ã— 0.3 = 0.410
   arousal = 0.7 Ã— 0.071 + 0.3 Ã— (-0.1) = 0.020
   ```
4. **æœ€ç»ˆ**: `{valence: 0.410, arousal: 0.020}`
5. **å­˜å‚¨**: è®°å¿†ä¸­æ·»åŠ æ­¤è®°å½•

#### äº¤äº’ 2: "Your prices are always fair!"
1. **ç¥ç»ç½‘ç»œé¢„æµ‹**: `{valence: 0.220, arousal: 0.190}`
2. **å…¨å±€è®°å¿†æƒ…ç»ª**:
   ```
   weight_1 = e^(-0.1 Ã— 0) = 1.0
   G_v = 0.3 + (0.410 - 0.3) Ã— 1.0 = 0.410
   G_a = -0.1 + (0.020 - (-0.1)) Ã— 1.0 = 0.020
   ```
3. **é’ˆå¯¹æ¥æºï¼ˆplayerï¼‰çš„è®°å¿†æƒ…ç»ª**:
   ```
   S_v = 0.410  (åªæœ‰ä¸€æ¡è®°å½•)
   S_a = 0.020
   ```
4. **èåˆ**ï¼ˆæœ‰æ¥æºå†å²ï¼‰:
   ```
   valence = 0.5 Ã— 0.410 + 0.35 Ã— 0.220 + 0.15 Ã— 0.410 = 0.343
   arousal = 0.5 Ã— 0.020 + 0.35 Ã— 0.190 + 0.15 Ã— 0.020 = 0.080
   ```
5. **æœ€ç»ˆ**: `{valence: 0.343, arousal: 0.080}`

#### äº¤äº’ 3: ç›—è´¼å‡ºç° "Give me all your gold!"
1. **ç¥ç»ç½‘ç»œé¢„æµ‹**: `{valence: 0.033, arousal: 0.239}`
2. **å…¨å±€è®°å¿†æƒ…ç»ª**:
   ```
   è®°å¿† 1: {v: 0.410, a: 0.020, w: 1.0}
   è®°å¿† 2: {v: 0.343, a: 0.080, w: 1.0}
   G_v = 0.3 + ((0.410-0.3)Ã—1.0 + (0.343-0.3)Ã—1.0) / 2.0 = 0.377
   G_a = -0.1 + ((0.020-(-0.1))Ã—1.0 + (0.080-(-0.1))Ã—1.0) / 2.0 = 0.050
   ```
3. **é’ˆå¯¹æ¥æºï¼ˆthiefï¼‰çš„è®°å¿†æƒ…ç»ª**: æ— è®°å½•
4. **èåˆ**ï¼ˆæ— æ¥æºå†å²ï¼‰:
   ```
   valence = 0.7 Ã— 0.033 + 0.3 Ã— 0.377 = 0.136
   arousal = 0.7 Ã— 0.239 + 0.3 Ã— 0.050 = 0.182
   ```
5. **æœ€ç»ˆ**: `{valence: 0.136, arousal: 0.182}`

**æƒ…ç»ªå˜åŒ–è½¨è¿¹**:
```
åˆå§‹åŸºçº¿:   valence=0.3,   arousal=-0.1
ä¸ç©å®¶äº¤äº’1: valence=0.410, arousal=0.020  (æ›´åŠ ç§¯æã€ç¨å¾®æ´»è·ƒ)
ä¸ç©å®¶äº¤äº’2: valence=0.343, arousal=0.080  (ä¿æŒç§¯æã€æ›´åŠ æ´»è·ƒ)
é‡åˆ°ç›—è´¼:   valence=0.136, arousal=0.182  (è½¬ä¸ºç´§å¼ ã€æ˜¾è‘—æ¿€åŠ¨)
```

### æ¡ˆä¾‹ 2: è®°å¿†è¡°å‡æ¼”ç¤º

**åœºæ™¯**: å•†äººè®°å¾—å¾ˆä¹…ä»¥å‰çš„ä¸€æ¬¡ä¸æ„‰å¿«ç»å†

**é…ç½®**: `decay_rate = 0.1`

**è®°å¿†è®°å½•**:
```json
[
  {
    "text": "You cheated me last time!",
    "valence": -0.5,
    "arousal": 0.4,
    "past_time": 0,    // åˆšå‘ç”Ÿ
    "source_id": "player"
  },
  {
    "text": "You cheated me last time!",
    "valence": -0.5,
    "arousal": 0.4,
    "past_time": 20,   // 20 æ—¶é—´å•ä½å‰
    "source_id": "player"
  }
]
```

**æƒé‡è®¡ç®—**:
```
è®°å¿†1: weight = e^(-0.1 Ã— 0) = 1.000   (100% æƒé‡)
è®°å¿†2: weight = e^(-0.1 Ã— 20) = 0.135  (13.5% æƒé‡)
```

**å¦‚æœç°åœ¨ç©å®¶è¯´ "Hello"**:
- ç¥ç»ç½‘ç»œé¢„æµ‹: `{valence: 0.5, arousal: 0.1}`
- é’ˆå¯¹ç©å®¶çš„è®°å¿†æƒ…ç»ª:
  ```
  åŸºç¡€æ€§æ ¼: {v: 0.3, a: -0.1}

  åŠ æƒåå·®:
  v_weighted = (-0.5-0.3)Ã—1.0 + (-0.5-0.3)Ã—0.135 = -0.908
  a_weighted = (0.4-(-0.1))Ã—1.0 + (0.4-(-0.1))Ã—0.135 = 0.568
  total_weight = 1.0 + 0.135 = 1.135

  S_v = 0.3 + (-0.908 / 1.135) = -0.500
  S_a = -0.1 + (0.568 / 1.135) = 0.400
  ```
- èåˆ:
  ```
  final_v = 0.5Ã—(-0.500) + 0.35Ã—0.5 + 0.15Ã—G_v
  final_a = 0.5Ã—0.400 + 0.35Ã—0.1 + 0.15Ã—G_a
  ```

**ç»“è®º**:
- æœ€è¿‘çš„è´Ÿé¢è®°å¿†æƒé‡æ˜¯æ—§è®°å¿†çš„ **7.4å€** (1.0 vs 0.135)
- æ—§è®°å¿†ä»æœ‰å½±å“ï¼Œä½†å·²å¤§å¹…å‡å¼±
- NPC å¯¹è¯¥ç©å®¶ä»ä¿æŒä¸€å®šè­¦æƒ•ï¼Œä½†ä¸å¦‚åˆšå‘ç”Ÿæ—¶é‚£ä¹ˆå¼ºçƒˆ

---

## å…³é”®è®¾è®¡ç‰¹ç‚¹

### 1. æƒ…ç»ªæƒ¯æ€§ (Emotional Inertia)
é€šè¿‡åŸºç¡€æ€§æ ¼ä½œä¸º"å¼•åŠ›ä¸­å¿ƒ"ï¼ŒNPC çš„æƒ…ç»ªä¼šé€æ¸å›å½’å…¶åŸºæœ¬æ€§æ ¼ã€‚

**å®ç°**:
```rust
valence_deviation = record.valence - personality_valence
// è®¡ç®—çš„æ˜¯ç›¸å¯¹äºåŸºç¡€æ€§æ ¼çš„åå·®ï¼Œæœ€åå†åŠ å›åŸºç¡€æ€§æ ¼
```

### 2. æ—¶é—´è¡°å‡ (Temporal Decay)
è®°å¿†å½±å“éšæ—¶é—´æŒ‡æ•°è¡°å‡ï¼Œç¬¦åˆå¿ƒç†å­¦ä¸­çš„**é—å¿˜æ›²çº¿**ã€‚

**Ebbinghaus é—å¿˜æ›²çº¿**:
```
è®°å¿†ä¿æŒç‡ = e^(-t/S)
```
å…¶ä¸­ S æ˜¯è®°å¿†å¼ºåº¦å¸¸æ•°ã€‚

### 3. å…³ç³»è®°å¿†ä¼˜å…ˆ (Relationship Priority)
ä¸ç‰¹å®šå¯¹è±¡çš„å†å²è®°å¿†æƒé‡æœ€é«˜ï¼ˆ50%ï¼‰ï¼Œç¬¦åˆäººç±»ç¤¾äº¤å¿ƒç†ã€‚

### 4. æƒ…ç»ªè¾¹ç•Œ (Emotion Bounds)
æ‰€æœ‰æƒ…ç»ªå€¼éƒ½é™åˆ¶åœ¨ [-1.0, 1.0]ï¼Œé˜²æ­¢æç«¯å€¼ã€‚

```rust
.clamp(-1.0, 1.0)
```

---

## æ€§èƒ½è€ƒè™‘

### è®¡ç®—å¤æ‚åº¦

1. **ç¥ç»ç½‘ç»œé¢„æµ‹**: O(1) - å›ºå®šæ¨¡å‹æ¨ç†æ—¶é—´
2. **è®°å¿†åŠ æƒè®¡ç®—**: O(n) - n æ˜¯è®°å¿†è®°å½•æ•°
3. **æƒ…ç»ªèåˆ**: O(1) - å›ºå®šæ•°é‡çš„åŠ æƒæ±‚å’Œ

### ä¼˜åŒ–å»ºè®®

**åœºæ™¯ 1: å¤§é‡å†å²è®°å¿†**
- **é—®é¢˜**: è®°å¿†è®°å½•è¿‡å¤šå¯¼è‡´è®¡ç®—ç¼“æ…¢
- **è§£å†³**:
  - å®šæœŸæ¸…ç†æƒé‡æä½çš„æ—§è®°å¿†ï¼ˆ`weight < 0.001`ï¼‰
  - é™åˆ¶æ¯ä¸ªæ¥æºçš„æœ€å¤§è®°å¿†æ•°é‡

**åœºæ™¯ 2: å®æ—¶å“åº”è¦æ±‚é«˜**
- **é—®é¢˜**: ç¥ç»ç½‘ç»œæ¨ç†å»¶è¿Ÿ
- **è§£å†³**:
  - ä½¿ç”¨æ¨¡å‹ç¼“å­˜ï¼ˆå·²å®ç°ï¼‰
  - è€ƒè™‘æ‰¹å¤„ç†å¤šä¸ªè¯·æ±‚

---

## æ‰©å±•å»ºè®®

### 1. æƒ…ç»ªåŠ¨æ€è¡°å‡
å½“å‰å®ç°ä¸­ `past_time` å›ºå®šä¸º 0ï¼Œå¯ä»¥ï¼š
- æ·»åŠ æ—¶é—´è·Ÿè¸ªç³»ç»Ÿ
- å®šæœŸæ›´æ–°æ‰€æœ‰è®°å¿†çš„ `past_time`
- å®ç°çœŸå®çš„è®°å¿†è¡°å‡

### 2. æƒ…ç»ªé˜ˆå€¼äº‹ä»¶
```rust
if final_valence < -0.7 && final_arousal > 0.6 {
    // è§¦å‘"æ„¤æ€’"äº‹ä»¶
    npc.become_hostile();
}
```

### 3. æƒ…ç»ªè½¬ç§»
```rust
// NPC å¯¹ç›—è´¼çš„è´Ÿé¢æƒ…ç»ªå¯èƒ½å½±å“å¯¹å…¶ä»–äººçš„æ€åº¦
if has_recent_negative_experience() {
    global_emotion.valence -= 0.1;
}
```

### 4. ç¾¤ä½“æƒ…ç»ª
```rust
// NPC ä¹‹é—´å¯ä»¥äº’ç›¸å½±å“æƒ…ç»ª
let nearby_npcs_emotion = calculate_group_emotion();
final_emotion = combine_with_group(personal_emotion, nearby_npcs_emotion);
```

---

## å‚è€ƒæ–‡çŒ®

1. **Russell, J. A. (1980)**. "A circumplex model of affect". *Journal of Personality and Social Psychology*, 39(6), 1161-1178.
   - æƒ…æ„ŸäºŒç»´æ¨¡å‹ï¼ˆValence-Arousal Modelï¼‰çš„ç†è®ºåŸºç¡€

2. **Ebbinghaus, H. (1885)**. "Memory: A Contribution to Experimental Psychology".
   - é—å¿˜æ›²çº¿ç†è®º

3. **Devlin, J., et al. (2018)**. "BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding".
   - BERT æ¨¡å‹åŸç†

4. **Becker-Asano, C., & Wachsmuth, I. (2010)**. "Affective computing with primary and secondary emotions in a virtual human". *Autonomous Agents and Multi-Agent Systems*, 20(1), 32-49.
   - è™šæ‹Ÿè§’è‰²æƒ…æ„Ÿè®¡ç®—

---

## æ€»ç»“

NPC Neural Affect Matrix ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°äº†é€¼çœŸçš„æƒ…ç»ªæ¨¡æ‹Ÿï¼š

1. âœ… **ç¥ç»ç½‘ç»œæƒ…æ„Ÿç†è§£** - å‡†ç¡®è¯†åˆ«æ–‡æœ¬æƒ…ç»ª
2. âœ… **è®°å¿†ç´¯ç§¯ä¸è¡°å‡** - æ¨¡æ‹ŸçœŸå®çš„è®°å¿†å½±å“
3. âœ… **å¤šå±‚æ¬¡æƒ…ç»ªèåˆ** - è€ƒè™‘å½“å‰ã€ä¸ªäººå’Œæ•´ä½“æƒ…ç»ª
4. âœ… **æ€§æ ¼ä¸€è‡´æ€§** - æƒ…ç»ªå›´ç»•åŸºç¡€æ€§æ ¼æ³¢åŠ¨
5. âœ… **å…³ç³»åŒºåˆ†èƒ½åŠ›** - å¯¹ä¸åŒå¯¹è±¡æœ‰ä¸åŒæƒ…ç»ªè®°å¿†

è¿™äº›ç‰¹æ€§ä½¿å¾— NPC èƒ½å¤Ÿï¼š
- å¯¹ä¸åŒç©å®¶æœ‰ä¸åŒæ€åº¦
- è®°ä½è¿‡å»çš„äº¤äº’å¹¶å½±å“å½“å‰ååº”
- ä¿æŒæ€§æ ¼ä¸€è‡´æ€§çš„åŒæ—¶å±•ç°æƒ…ç»ªå˜åŒ–
- éšæ—¶é—´é€æ¸"é—å¿˜"æ—§çš„æƒ…ç»ªè®°å¿†

**é€‚ç”¨åœºæ™¯**:
- è§’è‰²æ‰®æ¼”æ¸¸æˆ (RPG)
- ç¤¾äº¤æ¨¡æ‹Ÿæ¸¸æˆ
- è™šæ‹ŸåŠ©æ‰‹/èŠå¤©æœºå™¨äºº
- äº¤äº’å¼å™äº‹ç³»ç»Ÿ
